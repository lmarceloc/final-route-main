# Final Route - Documentacao Tecnica

## Visao geral da solucao
- Plataforma web para cadastrar entregas, visualizar pontos em mapa e gerar a melhor sequencia entre origem, paradas e destino final.
- Frontend em React + Vite + Typescript, com componentes reutilizaveis do design system (pasta `src/components/ui`) e estado global tratado localmente.
- Dados permanentes salvos na tabela `deliveries` do Supabase; leitura e escrita ocorrem diretamente via cliente oficial.
- Otimizacao de rotas feita por funcao edge `optimize-route`, que chama Mapbox Optimized Trips API respeitando prioridade de entregas urgentes.
- Processamento de notas fiscais XML feito por funcao edge `process-invoice`, liberando cadastros em lote a partir das informacoes do documento.

## Fluxo de alto nivel
1. Usuario abre `/` (arquivo `src/pages/Index.tsx`), onde a aplicacao cria o `QueryClient`, registra tooltips/toasts e monta a sidebar com formulario.
2. No carregamento inicial `Index` busca `deliveries` no Supabase, converte coordenadas e ordena origem -> urgentes -> paradas -> destino.
3. `AddDeliveryForm` permite incluir pontos individualmente ou via upload de NF; cada envio chama Supabase `insert` e atualiza o estado local.
4. A lista (`DeliveryList`) habilita edicoes, exclusoes e `drag-and-drop` (exceto origem/destino/urgentes). Toda mudanca sincroniza com Supabase.
5. Ao clicar em "Otimizar rota", o frontend aciona `supabase.functions.invoke("optimize-route")`; a resposta substitui a ordem atual e guarda resumo (distancia/duracao/geojson).
6. `MapboxMap` refaz marcadores e desenha a geometria retornada. Rotas otimizadas ficam visiveis, com origem verde e destino vermelho.
7. Dialogos de edicao (`EditDeliveryDialog`) atualizam registros no Supabase, com opcional geocodificacao via Nominatim quando o endereco muda.

## Persistencia (Supabase)
- Tabela central `public.deliveries` armazena cada parada da rota com coordenadas, prioridade e indicador de urgencia.
- `coordinates` aceita JSON (array `[lat, lng]` ou objeto), mas o frontend converte sempre para tupla numerica.
- `priority` pode ser usado para ordenacao customizada futura; hoje a ordenacao preferencial e derivada do fluxo.
- `is_urgent` define pontos fixos logo apos a origem na otimizacao.

```sql
-- Esquema de apoio (nao executar diretamente)
CREATE TABLE public.deliveries (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  created_at timestamptz NOT NULL DEFAULT now(),
  address text NOT NULL,
  coordinates jsonb,
  type text NOT NULL DEFAULT 'stop',
  is_urgent boolean NOT NULL DEFAULT false,
  priority integer NOT NULL DEFAULT 0,
  CONSTRAINT deliveries_pkey PRIMARY KEY (id)
);
```

## Funcoes edge Supabase
### `supabase/functions/optimize-route/index.ts`
- Recebe lista de entregas, garante que cada uma possua coordenadas (geocodifica via Mapbox quando faltar).
- Separa origem, destino, paradas urgentes e normais; chama Mapbox duas vezes para manter urgentes logo apos a origem.
- Consolida ordem final, distancia e duracao totais e devolve geometria `LineString` para o mapa.
- Requer variavel `MAPBOX_API_KEY` configurada no ambiente Supabase.

### `supabase/functions/process-invoice/index.ts`
- Recebe arquivos XML (NF-e ou CT-e), remove namespaces e extrai dados de emissor/destino.
- Monta enderecos legiveis (`logradouro`, `numero`, `bairro`, `municipio`, `uf`, `cep`) e identifica se todas as notas compartilham mesma origem.
- Retorna `origin`, lista `destinations` e o indicador `sameOrigin` para que o frontend crie entregas automaticamente.
- Disponibiliza CORS liberado; importante respeitar limites de uso conforme tamanho de arquivo enviado.

## Papeis dos principais arquivos do frontend
- `src/main.tsx`: ponto de entrada; cria `BrowserRouter` com flags de compatibilidade do React Router v7 e renderiza `App`.
- `src/App.tsx`: registra `QueryClientProvider`, `TooltipProvider` e sistemas de toast (`Toaster` e `Sonner`), define rotas `/` e catch-all `NotFound`.
- `src/pages/Index.tsx`: tela principal contendo estado de entregas, logica de integracao com Supabase, drag-and-drop, otimizacao de rota e renderizacao do mapa.
- `src/pages/NotFound.tsx`: pagina simples 404 com log no console para facilitar auditoria.

## Componentes reutilizaveis
- `src/components/AddDeliveryForm.tsx`: formulario completo para cadastrar entrega; inclui upload opcional de NF, campos de coordenadas e flag de urgencia.
- `src/components/DeliveryList.tsx`: lista com `react-beautiful-dnd`; bloqueia reorder de origem/destino/urgentes; oferece botoes de editar/excluir.
- `src/components/MapboxMap.tsx`: responsavel por instanciar mapa Mapbox GL, adicionar marcadores coloridos e desenhar a rota (`routeGeometry`).
- `src/components/EditDeliveryDialog.tsx`: dialogo modal (Shadcn) para ajustar endereco, tipo e coordenadas, incluindo geocodificacao manual.
- `src/components/geocode.ts`: helper para chamar Nominatim (OpenStreetMap) e gerar coordenadas quando usuario fornece apenas endereco.
- `src/components/SavedRoutes.tsx`: lista e gerencia rotas salvas em `localStorage`; pode ser plugada no layout caso seja necessario reutilizar otimizacoes.
- `src/components/DeliveryMap.tsx`: implementacao alternativa usando Leaflet; atualmente nao carregada em `Index`, mantida para cenarios sem Mapbox.
- `src/components/TirpSummary.tsx`: cartao de resumo (tempo/distancia) pensado para acompanhar resultados da otimizacao; ainda nao integrado ao layout atual.
- `src/components/SearchField.tsx`: campo de busca Leaflet GeoSearch; util somente com o mapa Leaflet.

## Hooks e utilitarios
- `src/hooks/use-mobile.tsx`: detecta breakpoint mobile (`< 768px`) via `matchMedia`, para adaptar layout responsivo.
- `src/hooks/use-toast.ts`: implementacao custom do sistema de toasts (limite de um toast simultaneo) usada pelos componentes de UI.
- `src/lib/utils.ts`: helper `cn` para combinar classes Tailwind usando `clsx` + `tailwind-merge`.

## Tipos compartilhados
- `src/types/delivery.ts`: contrato da entidade `Delivery` usado ao longo do frontend (inclui campos extras como `gate_code`, `order_type`, `stop_type` reservados para evolucoes).
- `src/integrations/supabase/types.ts`: tipagem gerada automaticamente a partir do schema Supabase; referencia para leituras/escritas.
- `src/integrations/supabase/client.ts`: instancia do client com `persistSession` em `localStorage`; depende de `VITE_SUPABASE_URL` e `VITE_SUPABASE_PUBLISHABLE_KEY`.

## Integracoes e configuracoes relevantes
- Mapbox: token hard-coded em `MapboxMap.tsx` para uso local; recomenda-se mover para variavel de ambiente antes de compartilhar com producao.
- Nominatim (OpenStreetMap): respeitar limite de uma requisicao por segundo quando `geocodeAddress` e chamado.
- Supabase: variaveis `VITE_SUPABASE_URL` e `VITE_SUPABASE_PUBLISHABLE_KEY` (frontend) + `MAPBOX_API_KEY` e qualquer segredo extra (funcoes edge).
- Dependencias principais: React Router, React Query, react-beautiful-dnd, Mapbox GL, lucide-react, Shadcn UI.

## Pontos para outros times
- Melhorias visuais ou integracao com outros ERPs podem usar os campos extras de `Delivery`.
- Caso seja necessario rodar sem Mapbox, basta substituir `MapboxMap` por `DeliveryMap` (Leaflet) e ajustar importacoes.
- Validar `SavedRoutes` e `TripSummary` se a equipe desejar oferecer historico de rotas e resumo fixo na interface.
